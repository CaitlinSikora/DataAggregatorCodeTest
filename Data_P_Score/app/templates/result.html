<!-- extend base layout -->
{% extends "base.html" %}

{% block content %}
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<style>

.axis path,
.axis line {
    fill: none;
    stroke: black;
    stroke-width: 0.5;
    /*stroke-dasharray: 1;*/
    shape-rendering: crispEdges;
    stroke-linecap: round;
}

.axis text {
    fill: black;
    stroke: none;
    font-size: 10px;
}

.mean {
    stroke: black;
    stroke-width: 0.5;
    /*stroke-dasharray: 1;*/
    shape-rendering: crispEdges;
    stroke-linecap: round;
}

.x text {
    fill: black;
    stroke: none;
    font-size: 20px;
}

.tick {
    stroke: black;
    /*stroke-dasharray: 1,2;*/
}

.bar {
    fill: black;
    border-radius: 1px;
    border: 1px solid;
    z-index: 999;
}

.plot {
    opacity: 0.6;
    height: auto;
    min-width: 674px;
    padding: 0;
    position: relative;
    width: 100%;
    text-align:center;
    background-size: cover;
    vertical-align: middle;
    overflow:show;
}
h2 {
	margin:30px 0 0;
    display: inline;
    vertical-align: middle;
    font-size: 30px;
    opacity: 1;
}
h3 {
    vertical-align: middle;
    font-size: 20px;
    line-height: 0.5;
    padding:0px;
    opacity: 1;
}
.messages {
	text-align: left;
    margin: 0px 25px 0px 25px;
    line-height: 1.2;
    font-size: 16px;
}

.messages p {
    text-align: left;
    margin: 7px 40px 0px 80px;
    font-size: 14px;
}

</style>
    <h2>{{ business_name }}, {{ location }}</h2>
    <h3>{{ business_type }} business owned by {{ owner }}</h3>

    <div class="plot"><svg id="visualisation" width="1000" height="360"></svg></div>
    <div class="messages"><p></p></div>

<script>
InitChart();
function InitChart() {

            var barData = {{ results | tojson }};
            var mean = 0
            for (i=0;i<barData.length;i++){
            	mean+=barData[i].y;
            }
            mean = Math.round(mean / barData.length*100)/100;
            $('#final').html(mean);
            console.log(mean);
            console.log(barData.length);
            var vis = d3.select('#visualisation'),
                WIDTH = 1000,
                HEIGHT = 360,
                MARGINS = {
                    top: 10,
                    right: 60,
                    bottom: 40,
                    left: 50
                },
                xRange = d3.scale.ordinal().rangeRoundBands([MARGINS.left, WIDTH - MARGINS.right], 0.1).domain(barData.map(function(d) {
                    return d.x;
                })),


                yRange = d3.scale.linear().range([HEIGHT-MARGINS.top, MARGINS.bottom]).domain([0,
                    d3.max(barData, function(d) {
                        return 1.0;
                    })
                ]),

                xAxis = d3.svg.axis()
                .tickFormat(function(d) {
                    return d
                })
                .scale(xRange)
                .tickSize(3)
                .tickSubdivide(true)
                .ticks(10),

                yAxis = d3.svg.axis()
                .scale(yRange)
                .tickSize(3)
                .orient("left")
                .tickSubdivide(true);

            vis.append('svg:g')
                .attr('class', 'x axis')
                .attr('transform', 'translate(0,' + (HEIGHT - MARGINS.bottom) + ')')
                .call(xAxis);

            vis.append('svg:g')
                .attr('class', 'y axis')
                .attr('transform', 'translate(' + (MARGINS.left) + ',-30)')
                .call(yAxis);

            vis.append("line")          
			    .attr("class", "mean")  
			    .attr("x1", MARGINS.left)     
			    .attr("y1", yRange(mean)-30)      
			    .attr("x2", WIDTH-MARGINS.right-20)     
			    .attr("y2", yRange(mean)-30);

			vis.append("text")
				.attr("x", WIDTH-MARGINS.right)
         		.attr("y", yRange(mean)+8)
         		.attr("style", "font-size:30px;")
                .text(mean)        

            vis.selectAll('rect')
                .data(barData)
                .enter()
                .append('rect')
                .attr('x', function(d) {
                    return xRange(d.x);
                })
                .attr('y', function(d) {
                    return yRange(d.y)-30;
                })
                .attr('width', xRange.rangeBand())
                .attr('height', function(d) {
                    return ((HEIGHT - MARGINS.bottom) - yRange(d.y)+30);
                })
                .attr({
                    ry: '5',
                    rx: '5'
                })
                .attr('fill', '#1474cd')
                .style("opacity", .65)
                .on('mouseover', function(d) {
                    d3.select(this)
                        .attr('fill', '#5caaf2');
                    console.log(d);
                    p_messages='';
                    for (i=0;i<d.z.length;i++){
                    	p_messages+='<p>'+d.z[i]+'</p>';
                    }
                    $('.messages').html(p_messages);
                })
                .on('mouseout', function(d) {
                    d3.select(this)
                        .attr('fill', '#1474cd');
                });

        }

</script>
{% endblock %}
